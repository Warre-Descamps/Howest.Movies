@using Howest.Movies.Dtos.Filters
@using Howest.Movies.Sdk.Endpoints.Abstractions
@using Howest.Movies.WebApp.Components.Dialogs
@using Howest.Movies.WebApp.Models
@inherits LayoutComponentBase

<MudThemeProvider/>
<MudDialogProvider/>
<MudSnackbarProvider/>

<MudLayout>
    <MudAppBar>
        <MudAutocomplete
            T="MovieResult" @bind-Value="_movieResult" ResetValueOnEmptyText="true" OnInternalInputChanged="Callback"
            SearchFuncWithCancel="@Search" Immediate="true" ToStringFunc="ToStringFunc" MinCharacters="2" Clearable="true"
            AdornmentIcon="@Icons.Material.Filled.Search" Adornment="Adornment.Start" Placeholder="Search"
            Margin="Margin.Dense" Variant="Variant.Outlined" Dense="true" Style="background: #edfff2; color: black; border-radius: .3em;">
            <ItemTemplate>
                <MovieListItem Movie="context"/>
            </ItemTemplate>
            <NoItemsTemplate>
                <MudText Typo="Typo.h5">No items found.</MudText>
            </NoItemsTemplate>
        </MudAutocomplete>
        <MudSpacer/>
        <MudMenu>
            <ActivatorContent>
                <MudAvatar>
                    @if (_login is not null)
                    {
                        @_login.Email.First()
                    }
                    else
                    {
                        <MudIconButton Icon="@Icons.Material.Filled.Login" Color="Color.Inherit"/>
                    }
                </MudAvatar>
            </ActivatorContent>
            <ChildContent>
                @if (_login is not null)
                {
                    <MudMenuItem OnClick="Logout">Logout</MudMenuItem>
                }
                else
                {
                    <MudMenuItem OnClick="OpenLoginDialogAsync">Login</MudMenuItem>
                    <MudMenuItem OnClick="OpenRegisterDialogAsync">Register</MudMenuItem>
                }
            </ChildContent>
        </MudMenu>
    </MudAppBar>
    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="my-5">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {
    private MovieResult? _movieResult;
    private User? _login;
    
    [Inject] private IMovieEndpoint MovieEndpoint { get; init; } = null!;
    [Inject] private NavigationManager NavigationManager { get; init; } = null!;
    [Inject] private IDialogService DialogService { get; init; } = null!;
    [Inject] private ISnackbar Snackbar { get; init; } = null!;
    
    private async Task<IEnumerable<MovieResult>> Search(string value, CancellationToken token)
    {
        var result = await MovieEndpoint.GetAsync(new MoviesFilter
        {
            Query = value
        }, new PaginationFilter(), token);
        return !result.IsSuccess ? new List<MovieResult>() : result.Data!.Items;
    }

    private string ToStringFunc(MovieResult arg)
    {
        return arg.Title;
    }

    private void Callback(ChangeEventArgs e)
    {
        Console.WriteLine("Callback");
        
        if (_movieResult is null)
            return;
        
        NavigationManager.NavigateTo($"/movie/{_movieResult.Id}");
    }

    private async Task OpenLoginDialogAsync()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium };
        var dialog = await DialogService.ShowAsync<LoginDialog>("Login", options);
        var result = await dialog.Result;
        if (result.Canceled)
            return;
        
        _login = result.Data as User;
        StateHasChanged();
        Snackbar.Add("Login successful", Severity.Success);
    }
    
    private async Task OpenRegisterDialogAsync()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium };
        var dialog = await DialogService.ShowAsync<RegisterDialog>("Register", options);
        var result = await dialog.Result;
        if (result.Canceled)
            return;
        
        Snackbar.Add("Registration successful", Severity.Success);
        await OpenLoginDialogAsync();
    }

    private void Logout()
    {
        _login = null;
        StateHasChanged();
        Snackbar.Add("Logout successful", Severity.Success);
    }

}